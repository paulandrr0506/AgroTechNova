<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Reportes Financieros - AgroTechNova</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <link rel="stylesheet" href="../public/css/base.css">
  <style>
    /* Animaciones */
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(20px); }
      to { opacity: 1; transform: translateY(0); }
    }

    @keyframes slideInRight {
      from { opacity: 0; transform: translateX(100px); }
      to { opacity: 1; transform: translateX(0); }
    }

    @keyframes slideOutRight {
      from { opacity: 1; transform: translateX(0); }
      to { opacity: 0; transform: translateX(100px); }
    }

    @keyframes pulse {
      0%, 100% { transform: scale(1); }
      50% { transform: scale(1.05); }
    }

    /* Cards de estad√≠sticas mejoradas */
    .stat-card-modern {
      background: white;
      border-radius: 15px;
      padding: 25px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.08);
      transition: all 0.3s;
      position: relative;
      overflow: hidden;
    }

    .stat-card-modern:hover {
      transform: translateY(-5px);
      box-shadow: 0 8px 24px rgba(0,0,0,0.12);
    }

    .stat-card-modern::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 4px;
      background: linear-gradient(90deg, var(--card-color-1), var(--card-color-2));
    }

    /* Barra de progreso circular */
    .circular-progress {
      width: 120px;
      height: 120px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      position: relative;
      background: conic-gradient(
        var(--progress-color) calc(var(--progress) * 1%),
        #e0e0e0 0
      );
    }

    .circular-progress::before {
      content: '';
      position: absolute;
      width: 100px;
      height: 100px;
      border-radius: 50%;
      background: white;
    }

    .circular-progress-text {
      position: relative;
      z-index: 1;
      font-size: 24px;
      font-weight: bold;
      color: var(--progress-color);
    }

    /* Tabla mejorada */
    .table-modern {
      width: 100%;
      border-collapse: separate;
      border-spacing: 0;
    }

    .table-modern thead tr {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
    }

    .table-modern th {
      padding: 15px;
      text-align: left;
      font-weight: 600;
    }

    .table-modern th:first-child {
      border-top-left-radius: 10px;
    }

    .table-modern th:last-child {
      border-top-right-radius: 10px;
    }

    .table-modern tbody tr {
      transition: all 0.3s;
      border-left: 4px solid transparent;
    }

    .table-modern tbody tr:nth-child(even) {
      background: #f8f9fa;
    }

    .table-modern tbody tr:hover {
      background: #e8f5e9;
      border-left-color: #4CAF50;
      transform: scale(1.01);
    }

    .table-modern td {
      padding: 18px 15px;
    }

    /* Scrollbar personalizada */
    ::-webkit-scrollbar {
      width: 10px;
      height: 10px;
    }

    ::-webkit-scrollbar-track {
      background: #f1f1f1;
      border-radius: 10px;
    }

    ::-webkit-scrollbar-thumb {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      border-radius: 10px;
    }

    /* Responsive */
    @media (max-width: 768px) {
      .table-modern {
        font-size: 12px;
      }
      
      .table-modern th,
      .table-modern td {
        padding: 10px 8px;
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <!-- Header con navegaci√≥n unificada -->
    <header>
      <div class="header-content">
        <img src="../images/logo.png" alt="Logo AgroTechnova" class="logo">
        <h1>üìä Reportes Financieros</h1>
        <div class="user-info">
          <span id="userName">Usuario</span>
          <button onclick="cerrarSesion()" class="btn-logout">Cerrar Sesi√≥n</button>
        </div>
      </div>
      <nav>
        <a href="dashboard.html">Dashboard</a>
        <a href="proyectos.html">Proyectos</a>
        <a href="usuarios.html">Usuarios</a>
        <a href="agendaReuniones.html">Agenda</a>
        
        <!-- Dropdown: Gesti√≥n Financiera -->
        <div class="nav-dropdown">
          <button class="nav-dropdown-btn">
            Gesti√≥n Financiera
            <i class="fas fa-chevron-down"></i>
          </button>
          <div class="nav-dropdown-content">
            <a href="recursos.html">Recursos</a>
            <a href="presupuestos.html">Presupuestos</a>
            <a href="gastos.html">Gastos</a>
          </div>
        </div>
        
        <!-- Dropdown: Inventario y Proveedores -->
        <div class="nav-dropdown">
          <button class="nav-dropdown-btn">
            Inventario y Proveedores
            <i class="fas fa-chevron-down"></i>
          </button>
          <div class="nav-dropdown-content">
            <a href="proveedores.html">Proveedores</a>
            <a href="productos.html">Productos</a>
            <a href="inventario.html">Inventario</a>
          </div>
        </div>

        <!-- Dropdown: Reportes y Documentaci√≥n -->
        <div class="nav-dropdown">
          <button class="nav-dropdown-btn active">
            Reportes y Documentaci√≥n
            <i class="fas fa-chevron-down"></i>
          </button>
          <div class="nav-dropdown-content">
            <a href="reportes.html" class="active">Reportes Financieros</a>
            <a href="proyectosFinalizados.html">Proyectos Finalizados</a>
            <a href="catalogo.html">Cat√°logo de Servicios</a>
          </div>
        </div>
      </nav>
    </header>

    <!-- Breadcrumb -->
    <div class="breadcrumb">
      <a href="dashboard.html">Dashboard</a>
      <span>‚Ä∫</span>
      <span>Reportes Financieros</span>
    </div>

    <!-- Reporte Consolidado Mejorado -->
    <section style="margin-bottom: 30px;">
      <div style="background: white; padding: 25px; border-radius: 15px; box-shadow: 0 4px 12px rgba(0,0,0,0.08); margin-bottom: 20px;">
        <h2 style="color: #2e7d32; margin-bottom: 25px; display: flex; align-items: center; gap: 12px;">
          <i class="fas fa-chart-line" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); background-clip: text; -webkit-background-clip: text; -webkit-text-fill-color: transparent; font-size: 32px;"></i>
          Reporte Consolidado del Sistema
        </h2>
        
        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px;">
          <!-- Total Proyectos -->
          <div class="stat-card-modern" style="--card-color-1: #667eea; --card-color-2: #764ba2;">
            <div style="display: flex; align-items: center; gap: 15px;">
              <div style="width: 60px; height: 60px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border-radius: 12px; display: flex; align-items: center; justify-content: center; color: white; font-size: 28px;">
                <i class="fas fa-project-diagram"></i>
              </div>
              <div style="flex: 1;">
                <div style="font-size: 14px; color: #666; margin-bottom: 5px;">Total Proyectos</div>
                <div id="totalProyectos" style="font-size: 32px; font-weight: bold; color: #667eea;">0</div>
                <div style="font-size: 12px; color: #999;">Activos en el sistema</div>
              </div>
            </div>
          </div>

          <!-- Presupuesto Total -->
          <div class="stat-card-modern" style="--card-color-1: #11998e; --card-color-2: #38ef7d;">
            <div style="display: flex; align-items: center; gap: 15px;">
              <div style="width: 60px; height: 60px; background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%); border-radius: 12px; display: flex; align-items: center; justify-content: center; color: white; font-size: 28px;">
                <i class="fas fa-wallet"></i>
              </div>
              <div style="flex: 1;">
                <div style="font-size: 14px; color: #666; margin-bottom: 5px;">Presupuesto Total</div>
                <div id="presupuestoTotal" style="font-size: 28px; font-weight: bold; color: #11998e;">$0</div>
                <div style="font-size: 12px; color: #999;">Inversi√≥n planificada</div>
              </div>
            </div>
          </div>

          <!-- Total Gastado -->
          <div class="stat-card-modern" style="--card-color-1: #f093fb; --card-color-2: #f5576c;">
            <div style="display: flex; align-items: center; gap: 15px;">
              <div style="width: 60px; height: 60px; background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); border-radius: 12px; display: flex; align-items: center; justify-content: center; color: white; font-size: 28px;">
                <i class="fas fa-hand-holding-usd"></i>
              </div>
              <div style="flex: 1;">
                <div style="font-size: 14px; color: #666; margin-bottom: 5px;">Total Gastado</div>
                <div id="totalGastado" style="font-size: 28px; font-weight: bold; color: #f5576c;">$0</div>
                <div style="font-size: 12px; color: #999;">Ejecutado</div>
              </div>
            </div>
          </div>

          <!-- Total Recursos -->
          <div class="stat-card-modern" style="--card-color-1: #4facfe; --card-color-2: #00f2fe;">
            <div style="display: flex; align-items: center; gap: 15px;">
              <div style="width: 60px; height: 60px; background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%); border-radius: 12px; display: flex; align-items: center; justify-content: center; color: white; font-size: 28px;">
                <i class="fas fa-tools"></i>
              </div>
              <div style="flex: 1;">
                <div style="font-size: 14px; color: #666; margin-bottom: 5px;">Total Recursos</div>
                <div id="totalRecursos" style="font-size: 32px; font-weight: bold; color: #4facfe;">0</div>
                <div style="font-size: 12px; color: #999;">Asignados</div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </section>

    <!-- Selector de Proyecto -->
    <section style="background: white; padding: 25px; border-radius: 10px; margin-bottom: 20px; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
      <h2 style="color: #2e7d32; margin-bottom: 20px;">üîç Generar Reporte por Proyecto</h2>
      
      <div style="display: grid; grid-template-columns: 1fr auto auto; gap: 15px; align-items: end;">
        <div class="form-group" style="margin: 0;">
          <label>Seleccionar Proyecto</label>
          <select id="proyectoSelect" style="width: 100%; padding: 12px; border: 2px solid #e0e0e0; border-radius: 5px;">
            <option value="">Cargando proyectos...</option>
          </select>
        </div>
        <button onclick="generarReporte()" class="btn-primary">üìä Generar Reporte</button>
        <button onclick="limpiarReporte()" class="btn-secondary">üîÑ Limpiar</button>
      </div>
    </section>

    <!-- Reporte del Proyecto -->
    <div id="reporteContainer" class="hidden">
      <!-- Informaci√≥n General -->
      <section style="background: white; padding: 25px; border-radius: 10px; margin-bottom: 20px; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
          <h2 style="color: #2e7d32; margin: 0;">üìÑ Reporte del Proyecto</h2>
          <div style="display: flex; gap: 10px;">
            <button onclick="exportarPDF()" class="btn-danger"><i class="fas fa-file-pdf"></i> Exportar PDF</button>
            <button onclick="exportarExcel()" class="btn-success"><i class="fas fa-file-excel"></i> Exportar Excel</button>
          </div>
        </div>

        <div style="background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%); padding: 25px; border-radius: 15px; margin-bottom: 25px; box-shadow: 0 4px 12px rgba(0,0,0,0.08);">
          <h3 id="proyectoNombre" style="color: #2e7d32; font-size: 26px; margin-bottom: 15px; font-weight: 700;">Nombre del Proyecto</h3>
          <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px;">
            <div style="background: white; padding: 15px; border-radius: 10px;">
              <div style="font-size: 13px; color: #666; margin-bottom: 5px;">Estado</div>
              <span id="proyectoEstado" class="badge" style="font-size: 14px;">-</span>
            </div>
            <div style="background: white; padding: 15px; border-radius: 10px;">
              <div style="font-size: 13px; color: #666; margin-bottom: 5px;">Fecha Inicio</div>
              <div id="proyectoFechaInicio" style="font-size: 16px; font-weight: 600; color: #333;">-</div>
            </div>
            <div style="background: white; padding: 15px; border-radius: 10px;">
              <div style="font-size: 13px; color: #666; margin-bottom: 5px;">Fecha Fin</div>
              <div id="proyectoFechaFin" style="font-size: 16px; font-weight: 600; color: #333;">-</div>
            </div>
          </div>
        </div>

        <!-- Presupuesto con Indicador Circular -->
        <div style="background: linear-gradient(135deg, #e3f2fd 0%, #bbdefb 100%); padding: 25px; border-radius: 15px; margin-bottom: 25px; box-shadow: 0 4px 12px rgba(0,0,0,0.08);">
          <h3 style="color: #1976d2; margin-bottom: 20px; display: flex; align-items: center; gap: 10px; font-weight: 600;">
            <i class="fas fa-wallet"></i> Presupuesto
          </h3>
          
          <div style="display: grid; grid-template-columns: auto 1fr; gap: 30px; align-items: center;">
            <!-- Indicador Circular -->
            <div style="display: flex; align-items: center; justify-content: center;">
              <div class="circular-progress" id="circularProgress" style="--progress: 0; --progress-color: #4CAF50;">
                <div style="background: white; width: 90px; height: 90px; border-radius: 50%; display: flex; flex-direction: column; align-items: center; justify-content: center;">
                  <div id="porcentajeEjecucion" style="font-size: 24px; font-weight: bold; color: #1976d2;">0%</div>
                  <div style="font-size: 11px; color: #666;">Ejecutado</div>
                </div>
              </div>
            </div>

            <!-- Detalles del Presupuesto -->
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 15px;">
              <div style="background: white; padding: 18px; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.06);">
                <div style="font-size: 13px; color: #666; margin-bottom: 8px; display: flex; align-items: center; gap: 8px;">
                  <i class="fas fa-money-bill-wave" style="color: #1976d2;"></i> Presupuesto Total
                </div>
                <div id="presupuestoTotalProyecto" style="font-size: 26px; font-weight: bold; color: #1976d2;">$0</div>
              </div>
              <div style="background: white; padding: 18px; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.06);">
                <div style="font-size: 13px; color: #666; margin-bottom: 8px; display: flex; align-items: center; gap: 8px;">
                  <i class="fas fa-arrow-up" style="color: #f57c00;"></i> Gastado
                </div>
                <div id="presupuestoGastado" style="font-size: 26px; font-weight: bold; color: #f57c00;">$0</div>
              </div>
              <div style="background: white; padding: 18px; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.06);">
                <div style="font-size: 13px; color: #666; margin-bottom: 8px; display: flex; align-items: center; gap: 8px;">
                  <i class="fas fa-piggy-bank" style="color: #4caf50;"></i> Disponible
                </div>
                <div id="presupuestoDisponible" style="font-size: 26px; font-weight: bold; color: #4caf50;">$0</div>
              </div>
            </div>
          </div>
        </div>

        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
          <!-- Recursos -->
          <div class="stat-card-modern" style="background: linear-gradient(135deg, #fff3e0 0%, #ffe0b2 100%); --card-color-1: #f57c00; --card-color-2: #ff9800;">
            <h3 style="color: #f57c00; margin-bottom: 18px; display: flex; align-items: center; gap: 10px; font-weight: 600;">
              <i class="fas fa-tools"></i> Recursos
            </h3>
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
              <div style="background: white; padding: 15px; border-radius: 10px; box-shadow: 0 2px 6px rgba(0,0,0,0.06);">
                <div style="font-size: 13px; color: #666; margin-bottom: 5px;">Total Recursos</div>
                <div id="totalRecursosProyecto" style="font-size: 28px; font-weight: bold; color: #f57c00;">0</div>
              </div>
              <div style="background: white; padding: 15px; border-radius: 10px; box-shadow: 0 2px 6px rgba(0,0,0,0.06);">
                <div style="font-size: 13px; color: #666; margin-bottom: 5px;">Costo Total</div>
                <div id="costoTotalRecursos" style="font-size: 28px; font-weight: bold; color: #f57c00;">$0</div>
              </div>
            </div>
          </div>

          <!-- Gastos -->
          <div class="stat-card-modern" style="background: linear-gradient(135deg, #ffebee 0%, #ffcdd2 100%); --card-color-1: #d32f2f; --card-color-2: #f44336;">
            <h3 style="color: #d32f2f; margin-bottom: 18px; display: flex; align-items: center; gap: 10px; font-weight: 600;">
              <i class="fas fa-credit-card"></i> Gastos
            </h3>
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
              <div style="background: white; padding: 15px; border-radius: 10px; box-shadow: 0 2px 6px rgba(0,0,0,0.06);">
                <div style="font-size: 13px; color: #666; margin-bottom: 5px;">Total Gastos</div>
                <div id="totalGastosProyecto" style="font-size: 28px; font-weight: bold; color: #d32f2f;">0</div>
              </div>
              <div style="background: white; padding: 15px; border-radius: 10px; box-shadow: 0 2px 6px rgba(0,0,0,0.06);">
                <div style="font-size: 13px; color: #666; margin-bottom: 5px;">Monto Total</div>
                <div id="montoTotalGastos" style="font-size: 28px; font-weight: bold; color: #d32f2f;">$0</div>
              </div>
            </div>
          </div>
        </div>
      </section>

      <!-- Detalles: Gastos por Categor√≠a -->
      <section style="background: white; padding: 25px; border-radius: 15px; margin-bottom: 25px; box-shadow: 0 4px 12px rgba(0,0,0,0.08);">
        <h3 style="color: #2e7d32; margin-bottom: 20px; display: flex; align-items: center; gap: 10px; font-weight: 600;">
          <i class="fas fa-chart-pie"></i> Gastos por Categor√≠a
        </h3>
        <div class="table-container" style="overflow-x: auto;">
          <table class="table-modern">
            <thead>
              <tr>
                <th><i class="fas fa-tag"></i> Categor√≠a</th>
                <th><i class="fas fa-hashtag"></i> Cantidad</th>
                <th><i class="fas fa-dollar-sign"></i> Total</th>
                <th><i class="fas fa-calculator"></i> Promedio</th>
              </tr>
            </thead>
            <tbody id="tablaCategorias">
              <tr><td colspan="4" style="text-align: center; padding: 30px; color: #999;">No hay datos disponibles</td></tr>
            </tbody>
          </table>
        </div>
      </section>

      <!-- Detalles: Recursos por Tipo -->
      <section style="background: white; padding: 25px; border-radius: 15px; margin-bottom: 25px; box-shadow: 0 4px 12px rgba(0,0,0,0.08);">
        <h3 style="color: #2e7d32; margin-bottom: 20px; display: flex; align-items: center; gap: 10px; font-weight: 600;">
          <i class="fas fa-cubes"></i> Recursos por Tipo
        </h3>
        <div class="table-container" style="overflow-x: auto;">
          <table class="table-modern">
            <thead>
              <tr>
                <th><i class="fas fa-layer-group"></i> Tipo</th>
                <th><i class="fas fa-hashtag"></i> Cantidad</th>
                <th><i class="fas fa-cubes"></i> Cantidad Total</th>
                <th><i class="fas fa-dollar-sign"></i> Costo Total</th>
              </tr>
            </thead>
            <tbody id="tablaRecursos">
              <tr><td colspan="4" style="text-align: center; padding: 30px; color: #999;">No hay datos disponibles</td></tr>
            </tbody>
          </table>
        </div>
      </section>
    </div>
  </div>

  <!-- Contenedor de Notificaciones -->
  <div id="notificaciones" style="position: fixed; top: 80px; right: 20px; z-index: 10000;"></div>

  <script>
    let proyectoSeleccionado = null;

    // Funci√≥n para mostrar notificaciones
    function mostrarNotificacion(mensaje, tipo = 'success') {
      const contenedor = document.getElementById('notificaciones');
      const notif = document.createElement('div');
      
      const colores = {
        success: 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)',
        error: 'linear-gradient(135deg, #f093fb 0%, #f5576c 100%)',
        warning: 'linear-gradient(135deg, #fa709a 0%, #fee140 100%)',
        info: 'linear-gradient(135deg, #4facfe 0%, #00f2fe 100%)'
      };
      
      const iconos = {
        success: 'fa-check-circle',
        error: 'fa-times-circle',
        warning: 'fa-exclamation-triangle',
        info: 'fa-info-circle'
      };
      
      notif.style.cssText = `
        background: ${colores[tipo]};
        color: white;
        padding: 15px 20px;
        border-radius: 10px;
        margin-bottom: 10px;
        box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        display: flex;
        align-items: center;
        gap: 12px;
        min-width: 300px;
        animation: slideInRight 0.3s ease-out;
      `;
      
      notif.innerHTML = `
        <i class="fas ${iconos[tipo]}" style="font-size: 20px;"></i>
        <span style="flex: 1;">${mensaje}</span>
        <i class="fas fa-times" style="cursor: pointer; opacity: 0.8;" onclick="this.parentElement.remove()"></i>
      `;
      
      contenedor.appendChild(notif);
      
      setTimeout(() => {
        notif.style.animation = 'slideOutRight 0.3s ease-in';
        setTimeout(() => notif.remove(), 300);
      }, 4000);
    }

    // Verificar sesi√≥n y cargar datos
    async function verificarSesion() {
      try {
        const response = await fetch('/api/auth/session');
        if (!response.ok) {
          window.location.href = '/login.html';
          return false;
        }
        const data = await response.json();
        document.getElementById('userName').textContent = data.user.nombre;
        return true;
      } catch (error) {
        window.location.href = '/login.html';
        return false;
      }
    }

    function cerrarSesion() {
      fetch('/api/auth/logout', { method: 'POST' })
        .then(() => window.location.href = '/login.html');
    }

    // Cargar proyectos
    async function cargarProyectos() {
      try {
        const response = await fetch('/api/projects');
        const data = await response.json();

        const select = document.getElementById('proyectoSelect');
        select.innerHTML = '<option value="">Seleccione un proyecto...</option>';

        if (data.projects && data.projects.length > 0) {
          data.projects.forEach(p => {
            select.innerHTML += `<option value="${p.id}">${p.nombre} (${p.estado})</option>`;
          });
        }
      } catch (error) {
        console.error('Error al cargar proyectos:', error);
      }
    }

    // Cargar reporte consolidado
    async function cargarReporteConsolidado() {
      try {
        const response = await fetch('/api/reports/consolidated');
        const data = await response.json();

        if (data.success && data.report) {
          const r = data.report;
          document.getElementById('totalProyectos').textContent = r.total_proyectos || 0;
          document.getElementById('presupuestoTotal').textContent = 
            `$${(r.presupuesto_total_sistema || 0).toLocaleString('es-CO')}`;
          document.getElementById('totalGastado').textContent = 
            `$${(r.total_gastado_sistema || 0).toLocaleString('es-CO')}`;
          document.getElementById('totalRecursos').textContent = r.total_recursos || 0;
        }
      } catch (error) {
        console.error('Error al cargar reporte consolidado:', error);
      }
    }

    // Generar reporte
    async function generarReporte() {
      const proyectoId = document.getElementById('proyectoSelect').value;
      if (!proyectoId) {
        mostrarNotificacion('Por favor seleccione un proyecto', 'warning');
        return;
      }

      proyectoSeleccionado = proyectoId;

      // Mostrar indicador de carga
      mostrarNotificacion('Generando reporte...', 'info');

      try {
        const response = await fetch(`/api/reports/financial/${proyectoId}`);
        const data = await response.json();

        if (data.success) {
          mostrarReporte(data.report);
          mostrarNotificacion('Reporte generado exitosamente', 'success');
        } else {
          mostrarNotificacion('Error al generar reporte', 'error');
        }
      } catch (error) {
        console.error('Error:', error);
        mostrarNotificacion('Error al generar reporte', 'error');
      }
    }

    // Mostrar reporte
    function mostrarReporte(report) {
      const g = report.general;

      // Informaci√≥n general
      document.getElementById('proyectoNombre').textContent = g.proyecto_nombre;
      document.getElementById('proyectoEstado').textContent = g.estado;
      document.getElementById('proyectoEstado').className = `badge badge-${g.estado}`;
      document.getElementById('proyectoFechaInicio').textContent = g.fecha_inicio || 'N/A';
      document.getElementById('proyectoFechaFin').textContent = g.fecha_fin || 'N/A';

      // Presupuesto
      document.getElementById('presupuestoTotalProyecto').textContent = 
        `$${(g.presupuesto_total || 0).toLocaleString('es-CO')}`;
      document.getElementById('presupuestoGastado').textContent = 
        `$${(g.presupuesto_gastado || 0).toLocaleString('es-CO')}`;
      document.getElementById('presupuestoDisponible').textContent = 
        `$${(g.presupuesto_disponible || 0).toLocaleString('es-CO')}`;
      
      // Actualizar porcentaje y color del indicador circular
      const porcentaje = g.porcentaje_ejecucion || 0;
      document.getElementById('porcentajeEjecucion').textContent = `${porcentaje}%`;
      
      // Actualizar el progreso circular
      const circularProgress = document.getElementById('circularProgress');
      circularProgress.style.setProperty('--progress', porcentaje);
      
      // Cambiar color seg√∫n el porcentaje
      let color;
      if (porcentaje < 50) {
        color = '#4CAF50'; // Verde - bajo consumo
      } else if (porcentaje < 75) {
        color = '#FF9800'; // Naranja - consumo medio
      } else if (porcentaje < 90) {
        color = '#f57c00'; // Naranja oscuro
      } else {
        color = '#f44336'; // Rojo - consumo alto
      }
      circularProgress.style.setProperty('--progress-color', color);

      // Recursos
      document.getElementById('totalRecursosProyecto').textContent = g.total_recursos || 0;
      document.getElementById('costoTotalRecursos').textContent = 
        `$${(g.costo_total_recursos || 0).toLocaleString('es-CO')}`;

      // Gastos
      document.getElementById('totalGastosProyecto').textContent = g.total_gastos || 0;
      document.getElementById('montoTotalGastos').textContent = 
        `$${(g.total_monto_gastos || 0).toLocaleString('es-CO')}`;

      // Gastos por categor√≠a
      const tablaCategorias = document.getElementById('tablaCategorias');
      if (report.gastosPorCategoria && report.gastosPorCategoria.length > 0) {
        tablaCategorias.innerHTML = report.gastosPorCategoria.map(c => `
          <tr>
            <td>${c.categoria}</td>
            <td>${c.cantidad}</td>
            <td>$${c.total.toLocaleString('es-CO')}</td>
            <td>$${c.promedio.toLocaleString('es-CO')}</td>
          </tr>
        `).join('');
      } else {
        tablaCategorias.innerHTML = '<tr><td colspan="4" class="text-center">No hay gastos registrados</td></tr>';
      }

      // Recursos por tipo
      const tablaRecursos = document.getElementById('tablaRecursos');
      if (report.recursosPorTipo && report.recursosPorTipo.length > 0) {
        tablaRecursos.innerHTML = report.recursosPorTipo.map(r => `
          <tr>
            <td>${r.tipo}</td>
            <td>${r.cantidad}</td>
            <td>${r.cantidad_total}</td>
            <td>$${r.costo_total.toLocaleString('es-CO')}</td>
          </tr>
        `).join('');
      } else {
        tablaRecursos.innerHTML = '<tr><td colspan="4" class="text-center">No hay recursos registrados</td></tr>';
      }

      // Mostrar contenedor
      document.getElementById('reporteContainer').classList.remove('hidden');
    }

    // Limpiar reporte
    function limpiarReporte() {
      document.getElementById('proyectoSelect').value = '';
      document.getElementById('reporteContainer').classList.add('hidden');
      proyectoSeleccionado = null;
      mostrarNotificacion('Reporte limpiado', 'info');
    }

    // Exportar a PDF
    function exportarPDF() {
      if (!proyectoSeleccionado) {
        mostrarNotificacion('Primero genere un reporte', 'warning');
        return;
      }
      mostrarNotificacion('Exportando a PDF...', 'info');
      window.open(`/api/reports/export/pdf/${proyectoSeleccionado}`, '_blank');
    }

    // Exportar a Excel
    function exportarExcel() {
      if (!proyectoSeleccionado) {
        mostrarNotificacion('Primero genere un reporte', 'warning');
        return;
      }
      mostrarNotificacion('Exportando a Excel...', 'info');
      window.open(`/api/reports/export/excel/${proyectoSeleccionado}`, '_blank');
    }

    // Inicializar
    window.onload = async () => {
      if (await verificarSesion()) {
        await cargarProyectos();
        await cargarReporteConsolidado();
      }
    };

    // Funcionalidad de dropdowns
    document.addEventListener('DOMContentLoaded', function() {
      const dropdownButtons = document.querySelectorAll('.nav-dropdown-btn');
      
      dropdownButtons.forEach(btn => {
        btn.addEventListener('click', function(e) {
          e.stopPropagation();
          const dropdown = this.parentElement;
          const isOpen = dropdown.classList.contains('open');
          
          document.querySelectorAll('.nav-dropdown').forEach(dd => {
            dd.classList.remove('open');
          });
          
          if (!isOpen) {
            dropdown.classList.add('open');
          }
        });
      });
      
      document.addEventListener('click', function() {
        document.querySelectorAll('.nav-dropdown').forEach(dd => {
          dd.classList.remove('open');
        });
      });
    });
  </script>
</body>
</html>
